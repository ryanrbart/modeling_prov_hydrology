---
title: "Analysis of Seasonal Fluxes and Storages"
output:
  html_document:
    theme: united
    df_print: paged
  html_notebook: default
  pdf_document: default
---

### Load libraries and functions

```{r message=FALSE, warning=FALSE}
source("0_utilities.R")
```

### Import the previously processed data

```{r Import data}
# A single data frame with each variable
data_seasonal <- read_csv("../output/data_seasonal.csv",
                        col_types = list(wy = col_character(),
                                        season = col_factor(levels = c("Jan-Mar",
                                                                       "Apr-Jun",
                                                                       "Jul-Sep",
                                                                       "Oct-Dec")),
                                         watershed = col_factor(),
                                         biomass = col_factor()))

# A list of data frames for each flux that has been differenced
diff_flux_seasonal <- read_rds("../output/diff_flux_seasonal.rds")
diff_storage_seasonal <- read_rds("../output/diff_storage_seasonal.rds")

```


***
### Plot relative change for fluxes for 50% thinning scenario

* x-axis: Wateryear (wy)
* y-axis: relative_50
    * Relative difference (%) between 50% thinning scenario and baseline (no thinning scenario)

##### Bottom Plot
* x-axis: Wateryear (wy)
* y-axis: Variable

```{r message=FALSE, warning=FALSE, results='hide'}

seasonal_fig <- function(.x=data, .y=var_name){
  # Make difference plot
  x <- ggplot(.x) +
    geom_col(aes(x=wy, y=relative_50)) +
    facet_grid(season~watershed, labeller = labeller()) +
    labs(title=paste(.y, "(1st)"), y="Change (%)") +
    theme(axis.text.x = element_text(angle = 270, hjust=0, vjust=0.6)) +
    NULL
  
  # Make seasonal plot
  y <- ggplot(data = .x) +
    geom_col(aes(x=wy, y=`100`)) +
    facet_grid(season~watershed, labeller = labeller()) +
    labs(title=paste(.y, "(2nd)"), y="Unthinned Value") +
    theme_grey(base_size = 10) +
    theme(axis.text.x = element_text(angle = 270, hjust=0, vjust=0.6)) +
    NULL
  
  # Make cowplot
  z <- cowplot::plot_grid(x,
                          y,
                          nrow=2)
  
  return(z)
}

purrr::map2(.x=diff_flux_seasonal,.y=flux_var, .f=seasonal_fig)

```

***
### Plot relative change for storages for 50% thinning scenario

* x-axis: Wateryear (wy)
* y-axis: relative_50
    * Relative difference (%) between 50% thinning scenario and baseline (no thinning scenario)

```{r message=FALSE, warning=FALSE, results='hide'}

purrr::map2(.x=diff_storage_seasonal,.y=storage_var, .f=seasonal_fig)

```

